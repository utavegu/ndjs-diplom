- Рефактор по тудусам
- ИвентЭмиттер в сокетах
- Аутентификация в сокетах (гарда не пускает, так как юзер не прикрепляется в реквест) - https://socket.io/how-to/use-with-express-session

- После тестирования всех мест с енв прикрути всё-таки конфиг, чисто в тренировочных целях. Понятно, что при использовании докер-композа тебе смысла в нём особого нет. Настройки подключения к БД через фабрику сделаешь и сервисы поинджектишь. Попробуешь с глобал и без. Также значения по умолчанию. Ещё, вероятно, там можно сразу преобразовывать тип значения при вытаскивании, но это не точно - проверь.


docker-compose -f docker-compose.dev.yml up
(тоже в ридми)

Когда будешь сдавать, сделай ветку prod и там все комментарии и тудусы почисти

Почему токен перестал протухать? Это в постмане что-то изменилось или у меня что-то сломалось?

Если успеешь, переделай авторизацию на сессионную (локал стрэтеджи), шляпа какая-то получилась с JWT. JWT в своем проекте обкатаешь уже без Пасспорта. Тогда и кастомный декоратор роли сможешь подключить.

Также на всё, что приходит с фронта, валидэйшн пайпы, если успеешь

БЭКЛОГ:

И токен при логине похоже всё-таки нужно ретурнить, иначе не взлетит. Но надо будет потестить (когда будет фронтенд)

Контроллер пользователей временно нужен для теста сервисов пользователей, не забудь удалить.

Разберись уже с дублированием асинк-эвэйтов в контроллерах и сервисах. По идее асинхронное только обращение в базу и значит эта обёртка нужна только в сервисе. (РЕФАКТОР)

Также надо что-то придумать с нэймингом методов контроллера и сервисов - когда они одинаковые, читаемость сильно падает (РЕФАКТОР)

Пабликами метить всё вроде как хороший тон, потому верни везже (РЕФАКТОР)

Слишком много однотипных оберток трай-кэтч

Фильтры и валидаторы - это вот не они ли хэлперс? (пока да, но лучше уточнить этот момент)

Инструкцию к АПИ или даже Сваггер обкатать - @nestjs/swagger

Рефактор: директория сетап/конфиг с настройками проекта.

Инструкции по тестированию для вебсокетов и авторизации сюда тоже
Тестируй авторизацию через заголовки - Authorication - Bearer *.*.* (в инструкцию, про второй способ тоже рассказать. Раздел "тестировщикам")

Для тестов в постмане (но потом большую портянку в dump):
{
  "email": "somemail@mail.ru",
  "passwordHash": "A1B54C93D01E442F58",
  "name": "Vasia",
  "contactPhone": "8-922-222-11-34",
  "role": "client"
}

ТЕСТИРОВАНИЕ:
- емэйл занят
- не хватает обязательных полей
- поля заполнены некорректными данными

Почитай по Partial в TS

Аццесс токен, рефреш токен... или уже не тут, а в своем проекте с фронтом. Также в своем проекте не подрубаешь сервис админки монги. Все запросы делаешь через монго шел.

Поиск по TODO


Документацию к апи сделай просто отдельным файлом md, со Сваггером тут, боюсь, могу не успеть



Краткая инструкция для тестирования websocket-ов через Postman:

    My Workspace
    New
    WebSocket Request
    Raw поменять на Socket.IO
    ws://localhost:ВНЕШНИЙ_ПОРТ_ПРИЛОЖЕНИЯ/
    Connect
    Запонлнить Event Name
    формат JSON
    Пример: { "text": "Сообщение" }
    В Listeners добавить имена событий, которые слушает клиент
    Send

Есть еще протокол wss. Не забывать делать дисконнект, если менялись переменные окружения. Входящие сообщения в постмане только что-то мне не приходят, но в базе данных все как надо меняется. Возможно это связано с тем, что у меня 2 разных события. Хотя если приконнектиться еще и с браузера - все исправно обновляется там, так что все ок вроде.

Как загружать файл или много файлов через постман - тоже инструкцию запили
Для загрузки нескольких файлов с помощью малтера через постман выбираем Post -> Body -> form-data (это малтипарт формдата). В столбце key пишем то, что указано в @UseInterceptors(FilesInterceptor('***')), а в столбце value - выбираем путь до файла. При мульти-загрузке файлов значение key во всех строках будет одно и то же, а в value - разные пути до файла. Если параллельно нужно будет передать body, то эти поля по тому же принципу пишутся в следующих строках. Только это будет малтипарт-формдата, потому... (нюансы работы с ней)

Документация к малтеру
https://github.com/expressjs/multer/blob/master/doc/README-ru.md

Тут не надо, но в своем проекте пригодится:
https://www.npmjs.com/package/sharp

На сколько правильно то, что у меня в хэлперах

Вообще мне нравится не типизировать ручки контроллера, как по мне - дублирующий код. Но следует уточнить по этой теме. То, что у меня сервис интерфейс наследует - уже более чем достаточно, по моему.

Через файлсистем автоматизировать создание public/img, если ее нет

По-хорошему ещё бы дэйт фнс подключить, чтобы красивые даты возвращать

Проблемы валидации формдаты через Joi. Также можно попробовать добить вопрос валидации через Joi ObjectId. Но мой текущий способ тоже норм, в целом.

С ролями чата нужно будет тоже пошаманить, но чат уже на самый десерт - после модуля броней

Сделать валидацию id через Pipe, предвариетльно освежив инфу по пайпам

Почитай чего написал в jwt.auth.guard.ts и подумай как это улучшить, задай вопрос дипруку. Но сделаешь это после тестирования всей API

Вероятно, директория helpers должна выглядеть несколько иначе, уточни у Артема Ч. Никита говорит, что это то же самое что утилс, нечто, что может быть использовано в сервисах. А всех остальных ребят по их директориям выноси на один уровнь с модулями (РЕФАКТОР). Гарды в модуль авторизации, так как они имеют отношение только к нему

pubic/client/index:
1) Авторизация и токен
2) Вебсокеты
3) Формдата и файл

лишние трайкэтчи? Проэкспериментируй на каком-нибудь сервисе

ConfigureService из @nestjs/config прикрути ближайшее время.

ПОХОЖЕ С ЭТОЙ ОШИБКОЙ НУЖНО РАЗОБРАТЬСЯ, ВОЗМОЖНО В НЕЙ КОРЕНЬ ПРОБЛЕМЫ
Возможно тут решение: https://stackoverflow.com/questions/64735881/typeerror-converting-circular-structure-to-json-starting-at-object-with-con
После реализации аутентификации через куки и логина такая вот ошибка, при этом приложение не валится:
[Nest] 289  - 04/06/2023, 11:19:46 AM   ERROR [ExceptionsHandler] Converting circular structure to JSON
aggregator-app     |     --> starting at object with constructor 'Socket'
aggregator-app     |     |     property '_writableState' -> object with constructor 'WritableState'
aggregator-app     |     |     property 'afterWriteTickInfo' -> object with constructor 'Object'
aggregator-app     |     --- property 'stream' closes the circle
aggregator-app     | TypeError: Converting circular structure to JSON
aggregator-app     |     --> starting at object with constructor 'Socket'
aggregator-app     |     |     property '_writableState' -> object with constructor 'WritableState'
aggregator-app     |     |     property 'afterWriteTickInfo' -> object with constructor 'Object'
aggregator-app     |     --- property 'stream' closes the circle
aggregator-app     |     at JSON.stringify (<anonymous>)
aggregator-app     |     at stringify (/app/node_modules/express/lib/response.js:1150:12)
aggregator-app     |     at ServerResponse.json (/app/node_modules/express/lib/response.js:271:14)
aggregator-app     |     at ExpressAdapter.reply (/app/node_modules/@nestjs/platform-express/adapters/express-adapter.js:61:62)
aggregator-app     |     at RouterResponseController.apply (/app/node_modules/@nestjs/core/router/router-response-controller.js:15:36)
aggregator-app     |     at /app/node_modules/@nestjs/core/router/router-execution-context.js:176:48
aggregator-app     |     at processTicksAndRejections (node:internal/process/task_queues:95:5)
aggregator-app     |     at /app/node_modules/@nestjs/core/router/router-execution-context.js:47:13
aggregator-app     |     at /app/node_modules/@nestjs/core/router/router-proxy.js:9:17

Малтер также настроить на ограничение веса файлов. И вероятно всю эту валидацию следует проводить уметь и на фронтэнде.

Для вебсокетов также валидации, пайпы, эксепшн фильтры и тд, так как есть нюансы и чтобы не забыть

На перспективу для твоего проекта. Можно через request.headers['user-agent'] проверять откуда зашел пользователь и если это не совпадает с его типичным местом - предупреждать на почту. Хотя это как-то более профессионально делается скорее всего. С участием ip, фингерпринта... поразбирайся в этой теме.

Важное по аутентификации из того, что в этом проекте у меня не реализовано:
- Соблюдение этих мер вкупе с частой ротацией Access/Refresh токенов должно помочь обеспечить высокий уровень безопасности на сайте.
- Cookies при правильном использовании являются адекватным и наиболее безопасным на данный момент решением для хранения JWT Access токена (реализовано, но тут смущает уточнение, что именно Access... Refresh, видимо, вообще нигде не храится. В общем поразбираешься еще)

Еще нужно получше разобраться с работой сессий в данном проекте. Пасспорт или экспресс. В мэйне и аус-модуле

В импортах порядок навести (РЕФАКТОР)

Помни, что пустые папки на гитхабе не сохраняются и всегда проверяй наличие, перед сохранением туда файла. Если нет - создавай (через фс)

Инструкция для тестирования. Аутентификация - через Authorization, через заголовки или через кукисы.

logger тоже неплохая штука, надо будет освоить после сдачи, можно прямо тут же

В своем проекте через класс валидатор делай валидацию, инструкция неста на нем
https://docs.nestjs.com/techniques/validation
В этом проекте я валидацию до ума не довёл, но в следующем обязательно закрой все эти дыры и используй другую либу валидации. И принцип работы пайпов хорошо изучи - их же можно прямо на отдельный параметр весить, и тд.
https://docs.nestjs.com/pipes#binding-validation-pipes
Ещё заметил, что валидэйшн пайпы глобальными делают, что мне не совсем понятно